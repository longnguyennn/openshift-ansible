---
- name: Gather OpenShift Logging Facts
  openshift_elasticsearch_facts:
    oc_bin: "{{openshift.common.client_binary}}"
    openshift_namespace: "{{openshift_elasticsearch_namespace}}"
    elasticsearch_clustername: "{{ openshift_elasticsearch_clustername }}"

- name: Validate Elasticsearch cluster size
  fail: msg="The openshift_elasticsearch_cluster_size may only be scaled down manually. Please see official documentation on how to do this."
  when: openshift_elasticsearch_facts.elasticsearch.deploymentconfigs | length > openshift_elasticsearch_cluster_size|int

- name: Set Elasticsearch project
  oc_project:
    state: present
    name: "{{ openshift_elasticsearch_namespace }}"

# Set up service accounts and roles
- include: "{{ role_path }}/tasks/service_accounts.yaml"

# Setup all configmaps and secrets
- include: "{{ role_path }}/tasks/es_node_configuration.yaml"

# Services
- name: create Elasticsearch 9200 service
  oc_service:
    namespace: "{{ openshift_elasticsearch_namespace }}"
    name: "{{ openshift_elasticsearch_clustername  }}"
    ports:
    - name: 9200-tcp
      port: 9200
      protocol: TCP
      targetPort: restapi
    selector:
      provider: openshift
      component: elasticsearch
    session_affinity: ClientIP
    service_type: ClusterIP

- name: create Elasticsearch 9300 service
  oc_service:
    namespace: "{{ openshift_elasticsearch_namespace }}"
    name: "{{ openshift_elasticsearch_clustername  }}-cluster"
    ports:
    - name: 9300-tcp
      port: 9300
      protocol: TCP
    selector:
      provider: openshift
      component: elasticsearch
    clusterip: None

# TODO: add more vars
# We don't allow scaling down of ES nodes currently
- include: "{{ role_path }}/tasks/install.yaml"
  vars:
    #generated_certs_dir: "{{openshift.common.config_base}}/logging"
    openshift_elasticsearch_deployment_name: "{{ item.0 }}"
    openshift_elasticsearch_pvc_name: "{{ item.1 }}"

    #openshift_logging_elasticsearch_storage_type: "{{ }}"
    openshift_elasticsearch_pvc_size: "{{ openshift_logging_es_pvc_size }}"
    openshift_elasticsearch_pvc_dynamic: "{{ openshift_logging_es_pvc_dynamic }}"
    openshift_elasticsearch_pvc_pv_selector: "{{ openshift_logging_es_pv_selector }}"

  with_together:
  - "{{ openshift_elasticsearch_facts.elasticsearch.deploymentconfigs }}"
  - "{{ openshift_elasticsearch_facts.elasticsearch.pvcs }}"

# Create any new DC that may be required
- include: "{{ role_path }}/tasks/install.yaml"
  vars:
    generated_certs_dir: "{{openshift.common.config_base}}/logging"
    openshift_elasticsearch_pvc_name: "{{ openshift_es_pvc_prefix }}-{{ ( item|int + ( openshift_elasticsearch_facts.elasticsearch.deploymentconfigs | count ) )|string }}"

  with_sequence: count={{ ( ( openshift_elasticsearch_cluster_size | int ) - ( openshift_elasticsearch_facts.elasticsearch.deploymentconfigs | count ) ) }}

- debug: var=openshift_elasticsearch_facts
